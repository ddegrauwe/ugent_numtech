\documentclass[a4paper]{article}
%
\usepackage{graphicx}
\usepackage{amsmath,amssymb}
%
\graphicspath{{./figures/}}

\title{%
	\bfseries%
	{\large Numerical Techniques Practicum 2}\\[3ex]
	{\Large Solving the advection equation}
}
%
\author{Daan Degrauwe}
%
\addtolength\textwidth{4cm}
\addtolength\evensidemargin{-2cm}
\addtolength\oddsidemargin{-2cm}
\addtolength\voffset{-2cm}
\addtolength\textheight{4cm}
\setlength\parindent{0pt}
\setlength\parskip{5pt}
\setlength\parsep{5pt}
%
\usepackage{etoolbox}
\makeatletter\preto{\@verbatim}{\topsep=2pt\partopsep=2pt}\makeatother
%
\begin{document}
%
NOTES
* inconsistency between k=[0,pi/dx] and k=[0,nx/2]
* missing adding PHI9 to arguments in leapfrog
%
\maketitle
%
\section{Introduction}
%
\par
The advection equation describes transport at a constant speed $c$:
%
\begin{equation}
	\frac{\partial \psi}{\partial t}+c\frac{\partial \psi}{\partial x}=0
\end{equation}
%
The exact solution is given by
%
\begin{equation}
	\psi(x,t)=\psi(x-ct,0)
\end{equation}
%
\par
For this exercise, runs will be done on the HPC of UGent, while visualization will be done in a Jupyter notebook. Check the practicum on Linux and Fortran if something is unclear about this.
%
\par\vspace*{3ex}
\textbf{Preparations}:
%
\begin{enumerate}
	\item From the command line, create a directory for this practicum and enter it with
		%
		\begin{verbatim}
			  $   mkdir -p ${HOME}/numtech/adveq
			  $   cd ${HOME}/numtech/adveq
		\end{verbatim}
		%
	\item Copy the Jupyter notebook for visualization with
		%
		\begin{verbatim}
			  $   cp /user/gent/407/vsc40744/ugent/numtech/practica/practicum2-adveq/src/adveq.ipynb .
		\end{verbatim}
		%
\end{enumerate}
%
\section{The upstream scheme}
%
\par
The upstream scheme discretizes the advection equation as
%
\begin{equation*}
	\frac{\phi^{n+1}_{j}-\phi^{n}_{j}}{\Delta t}+c\frac{\phi^{n}_{j}-\phi^{n}_{j-1}}{\Delta x}=0
\end{equation*}
%
or
%
\begin{equation*}
	\phi^{n+1}_{j}=(1-\mu)\phi^{n}_{j}+\mu\phi^{n}_{j-1}
\end{equation*}
%
where $\mu=\frac{c\Delta t}{\Delta x}$ is the Courant-number.
%
\par\vspace*{3ex}\clearpage
\textbf{Exercises}:
%
\begin{enumerate}
	\item Copy the directory containing the upstream scheme model to your own directory
		%
		\begin{verbatim}
			  $   cd ${HOME}/numtech/adveq/
			  $   cp -r /user/gent/407/vsc40744/ugent/numtech/practica/practicum2-adveq/src/upstream/ .
		\end{verbatim}
		%
	\item Go to this directory with
		%
		\begin{verbatim}
			  $   cd upstream
		\end{verbatim}
		%		
	\item Compile and run the code with
		%
		\begin{verbatim}
			  $   ./run.sh
		\end{verbatim}
		%
		%
	\item Launch a Jupyter notebook from \texttt{https://login.hpc.ugent.be}. Go to the directory \texttt{numtech/adveq/} and open the file \texttt{adveq.ipynb}.
		%
		\par
		The first two cells are just for loading packages and defining a plotting routine; execute them with \texttt{shift+enter}
		%
		\par
		The next cell allows to animate the results of the upstream scheme. Execute it with \texttt{shift+enter} (this takes some time!).
		%
	\item The stability condition for the upstream scheme is $0\leq\mu\leq1$. Find 3 ways to make the model unstable by changing parameters in \verb+setup.F90+ (open the file in Geany). Rerun after each modification.
		%
	\item Check the wavelength-dependency of the damping when $\mu=0.5$. This is done by modifying the wavenumber \verb+KX+ in the file \verb+exact_solution.F90+.
		\par
		Note: the amplification factor for $\mu=0.5$ is $A=\frac{1+\cos k\Delta x}{2}$ where $k$ is the wavenumber varying between 0 and $\pi/\Delta x$.
		%
	\item Why are the shortest waves often the most unstable?
		%
\end{enumerate}
%
\section{Forward scheme, centered spatial finite differences}
%
\par
This scheme discretizes the advection equation like
%
\begin{equation*}
	\frac{\phi^{n+1}-\phi^{n}}{\Delta t}+c\frac{\phi^{n}_{j+1}-\phi^{n}_{j-1}}{2\Delta x}=0
\end{equation*}
%
or
%
\begin{equation*}
	\phi^{n+1}=\phi^{n}-\frac{c\Delta t}{\Delta x}\frac{\phi^{n}_{j+1}-\phi^{n}_{j-1}}{2}
\end{equation*}
%
\par\vspace*{3ex}
\textbf{Exercises}:
%
\begin{enumerate}
	\item Start from a copy of the upstream scheme:
		%
		\begin{verbatim}
			  $   cd ${HOME}/numtech/adveq/
			  $   cp -r upstream/ forward_centered
			  $   cd forward_centered
		\end{verbatim}
		%
	\item Change the name of this scheme in \verb+setup.F90+:
		%
		\begin{verbatim}
			  WRITE (77,*) '"exact" "forward_centered"'      ! experiment names
		\end{verbatim}
		%
	\item Change the spatial discretization into centered finite differences by modifying the file \verb+timestep.F90+:
		%
		\begin{verbatim}
			  IF ( IX>1 .AND. IX<NX ) THEN
			    PHI1(IX)=PHI0(IX)-C*DT/DX*(PHI0(IX+1)-PHI0(IX-1))/2.
			  ELSEIF ( IX==1 ) THEN
			    ! periodic boundary conditions at left boundary
			    PHI1(1)=PHI0(1)-C*DT/DX*(PHI0(2)-PHI0(NX))/2.
			  ELSE
			    ! periodic boundary conditions at right boundary
			    PHI1(NX)=PHI0(NX)-C*DT/DX*(PHI0(1)-PHI0(NX-1))/2.
			  ENDIF		
		\end{verbatim}
		%
	\item Run with
		%
		\begin{verbatim}
			  $   ./run.sh
		\end{verbatim}
		%
	\item The scheme is unstable, especially for short waves. Try to make it stable by reducing the timestep in \verb+setup.F90+.
		%
	\item The scheme is unconditionally unstable! Centered finite differences are 2nd order accurate, while the upstream scheme is only 1st order accurate. How is it possible that going to a more accurate scheme leads to worse results?
		%
\end{enumerate}
%
\section{Leapfrog time stepping, centered spatial finite differences}
%
\par
The discretization of this scheme is
%
\begin{equation*}
	\frac{\phi^{n+1}_j-\phi^{n-1}_j}{2\Delta t}+c\frac{\phi^{n}_{j+1}-\phi^{n}_{j-1}}{2\Delta x}=0
\end{equation*}
%
or
%
\begin{equation*}
	\phi^{n+1}_j=\phi^{n-1}_j-\frac{c\Delta t}{\Delta x}\left(\phi^{n}_{j+1}-\phi^{n}_{j-1}\right)
\end{equation*}
%
\par\vspace*{3ex}
\textbf{Exercises}:
%
\begin{enumerate}
	\item Calculate the dispersion relation on paper. What is the stability condition?
		%
	\item Start from a copy of the forward-centered scheme:
		%
		\begin{verbatim}
			  $   cd ${HOME}/numtech/adveq
			  $   cp -r forward_centered/ leapfrog/
			  $   cd leapfrog
		\end{verbatim}
		%
	\item During the first timestep, the leapfrog scheme cannot be used. So a forward scheme will be taken during the first timestep. Separate subroutines for the forward and leapfrog schemes will be created:
		\par
		Rename the file \verb+timestep.F90+ to \verb+timestep_forward.F90+:
		%
		\begin{verbatim}
			  $   mv timestep.F90 timestep_forward.F90
		\end{verbatim}
		%
		Change the subroutine name in this file to \verb+TIMESTEP_FORWARD+.
		%
	\item Implement the leapfrog scheme starting from a copy of the forward scheme:
		%
		\begin{verbatim}
			  $   cp timestep_forward.F90 timestep_leapfrog.F90
		\end{verbatim}		
		%
		Change the subroutine name in this file to \verb+TIMESTEP_LEAPFROG+.
		%
		\par
		Modify this file so that it implements the leapfrog scheme. Note that this will require an additional argument for $\phi^{n-1}$.
		%
	\item Change the file \verb+timeloop.F90+	so that it calls the forward scheme only in the first timestep:
	
		\begin{verbatim}
			  IF (IT==1) THEN
			    CALL TIMESTEP_FORWARD(PHI0,PHI1)
			  ELSE
			    CALL TIMESTEP_LEAPFROG(PHI9,PHI0,PHI1)
			  ENDIF
		\end{verbatim}
		%
		\par
		Don't forget to declare the array \verb+PHI9+, and to store the current solution as the previous solution at the end of the timestep:
		%
		\begin{verbatim}
			  ! swap results
			  PHI9=PHI0
			  PHI0=PHI1
		\end{verbatim}
		%
	\item Change the compilation command in the run script \verb+run.sh+ so that it includes the files \verb+timestep_forward.F90+ and \verb+timestep_leapfrog.F90+. Run the program, and review the results.
		%
	\item Leapfrog is accelerating, centered differences are decelerating. Is the combination accelerating or decelerating?
		%
	\item What are the phase speed and group speed for very short waves? Check the wavenumber-dependency of the phase speed with your model.
		%
	\item The group speed can be visualized by considering a field composed of two harmonics in the file \verb+exact_solution.F90+:
		%
		\begin{equation*}
			\psi^0_j=\cos\left(2\pi k_1 \frac{j}{n_x} \right)+\cos\left(2\pi k_2 \frac{j}{n_x} \right)
		\end{equation*}
		%
		where $k_1$ and $k_2$ are the wavenumbers of the two harmonics and $n_x$ is the number of gridpoints.
		%
		\par
		Take $k_1=n_x/2-1$ and $k_2=n_x/2-2$ for a clear view of the group speed of short waves.
		%
\end{enumerate}
%
\section{Heun and Matsuno with centered spatial differences}
%
\par
(this section can be skipped if you want)
%
\par
The Heun scheme is given by
%
\begin{align*}
	\tilde \phi_j&=\phi_j^n-c\Delta t\frac{\phi^n_{j+1}-\phi^n_{j-1}}{2\Delta x}\\
	\phi^{n+1}_{j}&=\phi_j^n-c\frac{\Delta t}{2}\left(\frac{\phi^n_{j+1}-\phi^n_{j-1}}{2\Delta x}+\frac{\tilde \phi_{j+1}-\tilde \phi_{j-1}}{2\Delta x}\right)
\end{align*}
%
The Matsuno scheme is given by
%
\begin{align*}
	\tilde \phi_j&=\phi_j^n-c\Delta t\frac{\phi^n_{j+1}-\phi^n_{j-1}}{2\Delta x}\\
	\phi^{n+1}_{j}&=\phi_j^n-c\Delta t\frac{\tilde \phi_{j+1}-\tilde \phi_{j-1}}{2\Delta x}
\end{align*}
%
\par\vspace*{3ex}
\textbf{Exercise}:
%
\begin{enumerate}
	\item Implement and visualize these schemes (in separate directories). Are they stable?\\
		(the Heun scheme is only weakly unstable, so you may need many timesteps to detect the instability)
	\item Check that Matsuno is more damping for waves with an intermediate wavenumber ($k\sim n_x/4$) than for longer ($k\sim1$) or shorter ($k\sim n_x/2$) waves.
\end{enumerate}
%
\section{Spectral model}
%
\textbf{Exercises}:
%
\begin{enumerate}
	\item Think about switching from the upstream scheme (see above) to a trapezium scheme:
		%
		\begin{equation*}
			\frac{\phi^{n+1}_{j}-\phi^{n}_{j}}{\Delta t}+c\frac{1}{2}\left(\frac{\phi^{n+1}_{j+1}-\phi^{n+1}_{j-1}}{2\Delta x}+\frac{\phi^{n}_{j+1}-\phi^{n}_{j-1}}{2\Delta x}\right)=0
		\end{equation*}
		%
		Why would this be quite difficult?
		%
	\item Copy the spectral model with forward timestepping to your H-drive with
		%
		\begin{verbatim}
			  $   cd ${HOME}/numtech/adveq/ 
			  $   cp -r /user/gent/407/vsc40744/ugent/numtech/practica/ \
			         practicum2-adveq/src/forward_spectral/ .
		\end{verbatim}
		%
		The scheme is formulated in spectral space like
		%
		\begin{equation*}
			\frac{\hat\phi_k^{n+1}-\hat\phi_k^{n}}{\Delta t}+ikc\hat\phi_k^n=0
		\end{equation*}
		%
		or
		%
		\begin{equation*}
			\hat\phi_k^{n+1}=(1-ikc\Delta t)\hat\phi_k^n
		\end{equation*}
		%
		The code for this equation is found in the file \verb+timestep.F90+
	\item Go to this directory, compile and run with
		%
		\begin{verbatim}
			  $   cd ${HOME}/numtech/adveq/forward_spectral/
			  $   ./run.sh
		\end{verbatim}
		%
	\item Review the results in Jupyter like for previous exercises.
		%
		\par
Compare these results with those of the upstream scheme. Both models use a forward time scheme. How is it possible that changing to a more accurate space discretization (spectral is more accurate than 1st order decentered) gives worse results?
		%
	\item Try to implement trapezium timestepping. In spectral space, it looks like
		%
		\begin{equation*}
			\frac{\hat\phi^{n+1}_{k}-\hat\phi^{n}_{k}}{\Delta t}+\frac{ikc}{2}\left(\hat\phi^{n+1}_{k}+\hat\phi^{n}_{k}\right)=0
		\end{equation*}
		%
		or
		\begin{equation*}
			\hat\phi^{n+1}_{k}=\frac{1-ikc\Delta t/2}{1+ikc\Delta t/2}\hat\phi_k^n
		\end{equation*}
		%
		Try to destabilize this scheme by increasing the timestep. Try to explain what you see by considering the dispersion relation for this scheme:
		%
		\begin{equation*}
			\omega=\frac{2}{\Delta t}\arctan\left(\frac{ck\Delta t}{2}\right)
		\end{equation*}
\end{enumerate}
%
\end{document}
%
